---
title: "ã€ã‚¯ã‚½ã‚¢ãƒ—ãƒªã€‘ç¬ãè€ä¹…ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ä½œã£ãŸ"
datePublished: Fri Dec 06 2024 08:42:12 GMT+0000 (Coordinated Universal Time)
cuid: cm4chza0w000709jm43cr2qco
slug: 44cq44kv44k944ki44ox44oq44cr556s44gn6icq5lmf44ob44oj44os44oz44k444ks5l2c44gj44gf
canonical: https://qiita.com/nitaking/items/10e50d56e4733acb577b
tags: tensorflow, reactjs, nextjs, mediapipe, 44kv44k944ki44ox44oq

---

æœ¬è¨˜äº‹ã¯[ã‚¯ã‚½ã‚¢ãƒ—ãƒªã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼2024](https://qiita.com/advent-calendar/2024/kuso-app)ã®è¨˜äº‹ã§ã™ï¼

ã‚ã§ãŸã„10å‘¨å¹´ã¨ã„ã†ã“ã¨ã§å‚åŠ ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ğŸ‰

ã¨ã„ã†ã“ã¨ã§ã€

## ç¬ãè€ä¹…ã‚¢ãƒ—ãƒªã¤ãã£ãŸ

ç¬ãã€ã—ã¦ã„ã¾ã™ã‹ãƒ»ãƒ»ãƒ»ï¼Ÿ ã‚ã¾ã‚Šã«ã‚‚ç„¡æ„è­˜ã«ã—ã¦ã„ã‚‹ã®ã§ã€ã„ã–è¨€ã‚ã‚Œã¦ã¿ã‚‹ã¨ã©ã†ã§ã—ã‚‡ã†ã€‚ ã¾ã¶ãŸã®é‡ã¿ã€ç›®ã®ä¹¾ç‡¥ã€æ„Ÿã˜ã¾ã›ã‚“ã‹ãƒ»ãƒ»ãƒ»ï¼Ÿ

æ„è­˜ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã§è¦–ç•Œã¯å¤‰ã‚ã‚‹ã®ã§ã™ã€‚

ãã†ã€ç¬ãã‚’æ­¢ã‚ã¦ã¿ã¾ã—ã‚‡ã†ï¼

## ã§ããŸã‚‚ã®

(æ€¥ãªé¡”é¢å¤±ç¤¼ã—ã¾ã™)

![CleanShot 2024-12-06 at 16 27 29](https://github.com/user-attachments/assets/7cb6db84-3ea6-4653-b435-256f842e72b7 align="left")

[https://github.com/nitaking/blinking-endurance/b](https://github.com/nitaking/blinking-endurance/b)

## ãƒã‚¤ãƒ³ãƒˆ

* ç¬ãã®åˆ¤å®šãŒæ­£ç¢ºã§ã¯ãªã„
    

æ§‹æˆã®è§£èª¬è¨˜äº‹ã‚’æ›¸ã“ã†ã¨æ€ã£ã¦ã„ãŸãŒã€ç”ŸæˆAIãƒ™ãƒ¼ã‚¹ã§ä¸­èº«ã‚’ç†è§£ã™ã‚‹ã“ã¨ãªãå®Ÿè£…ã•ã‚Œã¦ã—ã¾ã£ãŸãŸã‚ã€ç”Ÿæˆç‰©ã‹ã‚‰ç´è§£ã„ã¦ã„ãã€‚

## æµã‚Œ

1. [v0.dev](http://v0.dev)ã«ã¦å©ãã‚’ä½œã‚‹
    
    * `tailwind`ãƒ™ãƒ¼ã‚¹ã§ã®ã‚¶ãƒƒã‚¯ãƒªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒå®Œæˆ
        
    * `Webcam`ã®å®Ÿè£…æ–¹æ³•ã‚’ã‚²ãƒƒãƒˆ
        
    * `tensorflow`ã‚’ç”¨ã„ãŸç›®ã¨ç¬ãåˆ¤å®šæ–¹æ³•ã‚’ã‚²ãƒƒãƒˆ
        
2. ç¬ãã®åˆ¤å®šãŒã•ã‚Œãªã„ãªã©ã®å‹•ä½œã‚’ä¿®æ­£(with GPT4o/GPT4o1-mini)
    

## æ§‹æˆè¦ç´ 

* webcam: `react-webcam`
    
    * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¡”ã¨ç¬ãã‚’æ¤œå‡º
        
* æ©Ÿæ¢°å­¦ç¿’: TensorFlow.js, MediaPipe FaceMesh
    
    * TensorFlow.js
        
        * ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§ã®æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«å®Ÿè¡Œã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
            
        * é¡”èªè­˜ã¨ç¬ãæ¤œå‡º
            
    * MediaPipe FaceMesh[^1](https://qiita.com/nemutas/items/6321aeca27492baeeb92)
        
        * é¡”ã®ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’æ¤œå‡ºã™ã‚‹ã€é«˜åº¦ãªé¡”ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯æ¤œå‡ºãƒ¢ãƒ‡ãƒ«
            
        * ç›®ã®ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦ã€ç¬ãã‚’æ¤œå‡º
            
        * Eye Aspect Ratio: ç¬ãåˆ¤å®šã®ãŸã‚ã«ç›®ã®é–‹é–‰çŠ¶æ…‹ã‚’è¨ˆç®—
            
* ç¬ãåˆ¤å®š
    
    * ç›®ã®é–‹é–‰çŠ¶æ…‹ã®è©•ä¾¡æŒ‡æ¨™ã€‚ä¸€å®šã®é–¾å€¤ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§åˆ¤å®šã€‚
        

## ç¬ãåˆ¤å®š: Eye Aspect Ratio

ç›®ã®è¤‡æ•°ã®ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆé–“ã®è·é›¢ã‹ã‚‰è¨ˆç®—

```ts
const calculateEAR = (eyePoints) => {
  // EAR = (|p2 - p6| + |p3 - p5|) / (2 * |p1 - p4|)
  const A = distance(eyePoints[1], eyePoints[5]);
  const B = distance(eyePoints[2], eyePoints[4]);
  const C = distance(eyePoints[0], eyePoints[3]);
  return (A + B) / (2.0 * C);
};
```

* distanceé–¢æ•°: 2ç‚¹é–“ã®ãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰è·é›¢ã‚’è¨ˆç®—ã€‚
    
* ã—ãã„å€¤ (blinkThreshold): EARãŒã“ã®å€¤ä»¥ä¸‹ã«ãªã‚‹ã¨ç¬ãã¨åˆ¤å®šï¼ˆé€šå¸¸0.2ï½0.25ï¼‰ã€‚
    

```ts
const distance = (p1: faceLandmarksDetection.Keypoint, p2: faceLandmarksDetection.Keypoint) => {
    return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
  };
```

é€£ç¶šãƒ•ãƒ¬ãƒ¼ãƒ æ•° (requiredBlinkFrames): ç¬ãã‚’å®‰å®šã—ã¦æ¤œå‡ºã™ã‚‹ãŸã‚ã«ã€é€£ç¶šã—ã¦EARãŒã—ãã„å€¤ä»¥ä¸‹ã§ã‚ã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ æ•°ã‚’å¿…è¦ã¨ã™ã‚‹ã€‚

ğŸ‘‰ï¸ ã“ã¡ã‚‰ã¯ç”ŸæˆAIã¯ç¬ãæ¤œå‡ºã®ç²¾åº¦å‘ä¸Šã®ç‚ºã«2ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½•åº¦ã‚‚æ±‚ã‚ã¦ããŸãŒã€ãã†ãªã‚‹ã¨20msç›®ã‚’é–‰ã˜ãŸã¨ãã ã‘ã—ã‹åˆ¤å®šã•ã‚Œãªã‹ã£ãŸã®ã§ã€1ãƒ•ãƒ¬ãƒ¼ãƒ (10ms)ã§ä»®è¨­å®šã€‚

## ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ç®¡ç†

ã“ã¡ã‚‰ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®å†æç”»ã«åˆã‚ã›ã¦ç¬ãã®ç¶™ç¶šçš„æ¤œå‡ºã‚’ç”¨ã„ã¦ã„ã‚‹ã¨ã®ã“ã¨ã ãŒã€ã“ã®ã‚„ã‚Šæ–¹ã§ãªãã¦ã‚‚ã‚ˆã„ã¨ã¯æ€ã£ã¦ã„ã¾ã™ã€‚

> * **ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ**: detectBlinké–¢æ•°å†…ã§requestAnimationFrameã‚’å†å¸°çš„ã«å‘¼ã³å‡ºã™ã“ã¨ã§ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ç¬ãæ¤œå‡ºã‚’è¡Œã„ã¾ã™ã€‚
>     
> * **ã‚­ãƒ£ãƒ³ã‚»ãƒ«**: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆæ™‚ã‚„ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®çµ‚äº†æ™‚ã«cancelAnimationFrameã‚’å‘¼ã³å‡ºã—ã€ãƒ«ãƒ¼ãƒ—ã‚’åœæ­¢ã—ã¾ã™ã€‚
>     

```javascript
useEffect(() => {
  if (model) {
    requestRef.current = requestAnimationFrame(detectBlink);
  }

  return () => {
    if (requestRef.current) {
      cancelAnimationFrame(requestRef.current);
    }
  };
}, [model]);
```

å®Ÿè£…æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã¯[ã“ã¡ã‚‰](https://github.com/nitaking/blinking-endurance/blob/main/app/page.tsx)ã€‚

[https://github.com/nitaking/blinking-endurance/blob/main/app/page.tsx](https://github.com/nitaking/blinking-endurance/blob/main/app/page.tsx)

## ã•ã„ã”ã«

æ‰€è¦æ™‚é–“ã¯ç´„2æ™‚é–“ã§ã€ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã™ã‚‹ã“ã¨ã«æ™‚é–“ã‚’å½“ã¦è¾¼ã¾ã‚Œã‚‹è»é…ã¨ãªã‚Šã¾ã—ãŸã€‚

Webcamã‚’ä½¿ã£ãŸå®Ÿè£…ã‚‚ã€TensorFlowã‚’ä½¿ã£ãŸå®Ÿè£…ã‚‚çµŒé¨“ãŒãªã‹ã£ãŸãŸã‚ã€å­¦ã³ãŒæ·±ã„ã§ã™ã€‚ æ„å¤–ã¨ç°¡å˜ã«å®Ÿè£…ãŒã§ãã‚‹ã¨æ€ã„ã¤ã¤ã€ç”ŸæˆAIãŒãªã‹ã£ãŸã‚‰ç¬ãåˆ¤å®šã§æ™‚é–“ãŒæº¶ã‘ãã†ã ãªã¨ã„ã†æ‰€æ„Ÿã§ã—ãŸã€‚

ã¨ã„ã†ã“ã¨ã§ã€ã‚¯ã‚½ã‚¢ãƒ—ãƒªã‚’ä½œã‚‹ã¤ã‚‚ã‚ŠãŒãªã‚“ã ã‹ãã“ã¾ã§ã‚¯ã‚½ã§ã‚‚ãªãã€å­¦ã°ã›ã¦é ‚ã„ãŸä»¶ã§ã—ãŸã€œï¼